<!DOCTYPE html>
<html lang="zh-CN">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<title>ECON2501 Game Theory Lab | åšå¼ˆè®ºå®éªŒå®¤</title>
<style>
  @import url('https://fonts.googleapis.com/css2?family=Noto+Serif+SC:wght@400;600;700;900&display=swap');
  * { box-sizing: border-box; margin: 0; padding: 0; }
  html, body { height: 100%; overflow-x: hidden; }
  body {
    font-family: 'Georgia', 'Noto Serif SC', serif;
    -webkit-font-smoothing: antialiased;
    background: #0B1120;
    color: #E8ECF4;
  }
  input::placeholder { color: #5A6478; }
  button { font-family: 'Georgia', 'Noto Serif SC', serif; }
  @keyframes spin { to { transform: rotate(360deg); } }
  @keyframes fadeUp { from { opacity:0; transform:translateY(20px); } to { opacity:1; transform:translateY(0); } }
  @keyframes pulse { 0%,100% { opacity:1; } 50% { opacity:0.5; } }
  @keyframes confetti {
    0% { opacity:1; transform: translate(0,0) rotate(0deg) scale(1); }
    100% { opacity:0; transform: translate(var(--tx), var(--ty)) rotate(720deg) scale(0.3); }
  }
  .fade-up { animation: fadeUp 0.5s ease-out forwards; }
  .fade-up-1 { animation-delay: 0.1s; opacity: 0; }
  .fade-up-2 { animation-delay: 0.2s; opacity: 0; }
  .fade-up-3 { animation-delay: 0.3s; opacity: 0; }
  .btn-press { transition: transform 0.12s ease; }
  .btn-press:active { transform: scale(0.95); }
</style>
</head>
<body>
<div id="app"></div>

<!-- Firebase SDK (compat for simplicity) -->
<script src="https://www.gstatic.com/firebasejs/10.12.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.12.0/firebase-database-compat.js"></script>

<!-- React -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/react/18.2.0/umd/react.production.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/react-dom/18.2.0/umd/react-dom.production.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/babel-standalone/7.23.9/babel.min.js"></script>

<script type="text/babel">
const { useState, useEffect, useRef, useCallback } = React;

// ================================================================
// ğŸ”¥ FIREBASE CONFIG â€” Replace with your own!
// ================================================================
// Steps:
// 1. Go to https://console.firebase.google.com
// 2. Click "Add project" â†’ name it "game-theory-lab" â†’ Create
// 3. Click "Build" â†’ "Realtime Database" â†’ "Create Database" â†’ Start in TEST mode
// 4. Go to Project Settings (gear icon) â†’ scroll to "Your apps" â†’ click "</>" (Web)
// 5. Register app â†’ copy the firebaseConfig object â†’ paste below
// ================================================================

const firebaseConfig = {
  apiKey: "AIzaSyCPofplryBpIRHJyidUvej1kEj_7f_EFNQ",
  authDomain: "game-theory-36dc1.firebaseapp.com",
  databaseURL: "https://game-theory-36dc1-default-rtdb.asia-southeast1.firebasedatabase.app",
  projectId: "game-theory-36dc1",
  storageBucket: "game-theory-36dc1.firebasestorage.app",
  messagingSenderId: "655138906576",
  appId: "1:655138906576:web:1f8929a514cb2772e259d5",
  measurementId: "G-5VQJQBED35"
};

let db = null;
let firebaseReady = false;
try {
  if (firebaseConfig.apiKey) {
    firebase.initializeApp(firebaseConfig);
    db = firebase.database();
    firebaseReady = true;
  }
} catch (e) {
  console.warn("Firebase not configured:", e);
}

// ================================================================
// CONSTANTS
// ================================================================
const C = {
  BLUE: "#1F3864", HEADER: "#2E5A88", RED: "#C00000",
  GOLD: "#D4A84B", BG: "#0B1120", CARD: "#131B2E",
  SURFACE: "#1A2540", TEXT: "#E8ECF4", TEXT2: "#8B95A8",
  DIM: "#5A6478", GREEN: "#4CAF50", PURPLE: "#B08DE0",
  ALPHA_BG: "#1A3050", BETA_BG: "#2A1A40",
  ALPHA_C: "#5BA8E0", BETA_C: "#B08DE0",
};

// ================================================================
// GAME DEFINITIONS
// ================================================================
const GAMES = {
  grade_game: {
    id: "grade_game", name: "The Grade Game", nameCN: "æˆç»©åšå¼ˆ", week: 1,
    desc: "Choose Î± or Î². Your grade depends on both choices.",
    descCN: "é€‰æ‹© Î± æˆ– Î²ã€‚ä½ çš„æˆç»©å–å†³äºåŒæ–¹çš„é€‰æ‹©ã€‚",
    strategies: ["Î±", "Î²"],
    payoffs: {
      "Î±,Î±": { label: "Bâˆ’, Bâˆ’", p1: 0, p2: 0 },
      "Î±,Î²": { label: "A, C",   p1: 3, p2: -1 },
      "Î²,Î±": { label: "C, A",   p1: -1, p2: 3 },
      "Î²,Î²": { label: "B+, B+", p1: 1, p2: 1 },
    },
    matrix: [
      ["", "å¯¹æ–¹ Î±", "å¯¹æ–¹ Î²"],
      ["ä½  Î±", "Bâˆ’, Bâˆ’", "A, C"],
      ["ä½  Î²", "C, A", "B+, B+"],
    ],
    lessons: {
      "Î±,Î±": "ä½ ä»¬éƒ½é€‰äº†ã€Œè‡ªç§ã€ç­–ç•¥ Î± â€”â€” ç†æ€§é€‰æ‹©å¯¼è‡´äº†åŒè¾“ã€‚è¿™å°±æ˜¯å›šå¾’å›°å¢ƒçš„æ ¸å¿ƒï¼šä¸ªä½“ç†æ€§â‰ é›†ä½“ç†æ€§ã€‚",
      "Î±,Î²": "ä½ æ‹¿äº†Aï¼Œå¯¹æ–¹æ‹¿äº†Cã€‚å ä¼˜ç­–ç•¥çš„è¯±æƒ‘å°±åœ¨è¿™é‡Œâ€”â€”ä½†å¦‚æœå¯¹æ–¹åœ¨ä¹å…¬å¹³ï¼Œè¿™ä¸ªåšå¼ˆå°±å®Œå…¨ä¸åŒäº†ã€‚",
      "Î²,Î±": "ä½ é€‰äº†åˆä½œï¼Œä½†å¯¹æ–¹èƒŒå›äº†ä½ ã€‚åœ¨æ²¡æœ‰æƒ©ç½šæœºåˆ¶çš„å•æ¬¡åšå¼ˆä¸­ï¼Œåˆä½œè€…å®¹æ˜“åƒäºã€‚",
      "Î²,Î²": "æ­å–œï¼ä½ ä»¬éƒ½é€‰æ‹©äº†åˆä½œã€‚ä½†æ³¨æ„ï¼šÎ± æ˜¯å ä¼˜ç­–ç•¥ã€‚ä½ ä»¬æ˜¯ã€Œæ„¤æ€’çš„å¤©ä½¿ã€è¿˜æ˜¯æ²¡å‘ç°è¿™ä¸€ç‚¹ï¼Ÿ",
    },
    lessonTitle: "è¿™æ˜¯å›šå¾’å›°å¢ƒï¼ This is a Prisoner's Dilemma!",
  },
};

// AI Strategies
const AI = {
  random: { name: "éšæœº Random", fn: () => Math.random() < 0.5 ? "Î±" : "Î²" },
  selfish: { name: "è‡ªç§é¬¼ Evil Git", fn: () => "Î±" },
  cooperative: { name: "åˆä½œè€… Cooperative", fn: () => "Î²" },
  titfortat: { name: "ä»¥ç‰™è¿˜ç‰™ Tit-for-Tat", fn: (h) => h.length === 0 ? "Î²" : h[h.length-1].opp },
};

// ================================================================
// FIREBASE HELPERS
// ================================================================
function generateId() {
  return Date.now().toString(36) + Math.random().toString(36).slice(2,8);
}

// ================================================================
// APP COMPONENT
// ================================================================
function App() {
  const [screen, setScreen] = useState("home");
  const [name, setName] = useState(() => {
    try { return localStorage.getItem("gt_name") || ""; } catch { return ""; }
  });
  const [mode, setMode] = useState("human");
  const [aiType, setAiType] = useState("random");
  const [waiting, setWaiting] = useState(false);
  const [choice, setChoice] = useState(null);
  const [result, setResult] = useState(null);
  const [showMatrix, setShowMatrix] = useState(false);
  const [aiHistory, setAiHistory] = useState([]);
  const [stats, setStats] = useState({ alpha: 0, beta: 0, results: [] });
  const [waitDots, setWaitDots] = useState("");

  const gameId = "grade_game";
  const game = GAMES[gameId];
  const myId = useRef(generateId());
  const listenersRef = useRef([]);

  // Save name
  useEffect(() => {
    try { if (name) localStorage.setItem("gt_name", name); } catch {}
  }, [name]);

  // Waiting dots animation
  useEffect(() => {
    if (!waiting) return;
    const iv = setInterval(() => setWaitDots(d => d.length >= 3 ? "" : d + "."), 500);
    return () => clearInterval(iv);
  }, [waiting]);

  // Cleanup firebase listeners on unmount
  useEffect(() => {
    return () => listenersRef.current.forEach(off => off());
  }, []);

  // ---- HUMAN MATCHING via Firebase ----
  const submitHuman = async (myChoice) => {
    if (!firebaseReady) {
      alert("Firebase æœªé…ç½®ï¼è¯·æŒ‰ç…§è¯´æ˜è®¾ç½® Firebaseã€‚\nFirebase not configured! Follow setup instructions.");
      return;
    }
    setChoice(myChoice);
    setWaiting(true);

    const myRef = db.ref(`games/${gameId}/pending/${myId.current}`);
    await myRef.set({
      name: name || "åŒ¿å",
      choice: myChoice,
      timestamp: firebase.database.ServerValue.TIMESTAMP,
    });

    // Listen for match result
    const matchRef = db.ref(`games/${gameId}/matches/${myId.current}`);
    const onMatch = matchRef.on("value", (snap) => {
      const match = snap.val();
      if (!match) return;
      matchRef.off("value", onMatch);
      const key = `${myChoice},${match.opponentChoice}`;
      const po = game.payoffs[key];
      const res = {
        myChoice, oppChoice: match.opponentChoice,
        oppName: match.opponentName,
        label: po.label, myPay: po.p1, oppPay: po.p2,
        key,
      };
      setResult(res);
      setWaiting(false);
      setScreen("result");

      // Record to results log
      db.ref(`games/${gameId}/results`).push({
        player: name || "åŒ¿å", choice: myChoice,
        opponent: match.opponentName, oppChoice: match.opponentChoice,
        payoff: po.p1, timestamp: firebase.database.ServerValue.TIMESTAMP,
      });
    });
    listenersRef.current.push(() => matchRef.off("value", onMatch));

    // Try to find a match
    const pendingRef = db.ref(`games/${gameId}/pending`);
    const onPending = pendingRef.on("value", async (snap) => {
      const pending = snap.val();
      if (!pending) return;

      const others = Object.entries(pending).filter(([id]) => id !== myId.current);
      if (others.length === 0) return;

      // Pick first available opponent
      const [oppId, oppData] = others[0];

      // Atomic match: try to remove both pending entries
      const updates = {};
      updates[`games/${gameId}/pending/${myId.current}`] = null;
      updates[`games/${gameId}/pending/${oppId}`] = null;
      updates[`games/${gameId}/matches/${myId.current}`] = {
        opponentChoice: oppData.choice,
        opponentName: oppData.name,
      };
      updates[`games/${gameId}/matches/${oppId}`] = {
        opponentChoice: myChoice,
        opponentName: name || "åŒ¿å",
      };

      try {
        await db.ref().update(updates);
        pendingRef.off("value", onPending);
      } catch (e) {
        // Another client may have matched first, keep waiting
      }
    });
    listenersRef.current.push(() => pendingRef.off("value", onPending));

    // Timeout after 60s
    setTimeout(() => {
      if (waiting) {
        myRef.remove();
        pendingRef.off("value", onPending);
        matchRef.off("value", onMatch);
        setWaiting(false);
        alert("é…å¯¹è¶…æ—¶ï¼Œè¯·é‡è¯•ã€‚ Matching timed out, please try again.");
        setScreen("play");
        setChoice(null);
      }
    }, 60000);
  };

  // ---- AI PLAY ----
  const submitAI = (myChoice) => {
    setChoice(myChoice);
    setWaiting(true);
    setTimeout(() => {
      const aiChoice = AI[aiType].fn(aiHistory);
      const key = `${myChoice},${aiChoice}`;
      const po = game.payoffs[key];
      const res = {
        myChoice, oppChoice: aiChoice,
        oppName: `AI (${AI[aiType].name})`,
        label: po.label, myPay: po.p1, oppPay: po.p2, key,
      };
      setAiHistory(prev => [...prev, { mine: myChoice, opp: aiChoice }]);
      setResult(res);
      setWaiting(false);
      setScreen("result");
    }, 600 + Math.random() * 600);
  };

  const handleChoice = (c) => {
    if (mode === "ai") submitAI(c);
    else submitHuman(c);
  };

  const playAgain = () => {
    myId.current = generateId();
    setChoice(null); setResult(null); setScreen("play");
  };

  // ---- TEACHER STATS ----
  const loadStats = () => {
    if (!firebaseReady) {
      setStats({ alpha: 0, beta: 0, results: [] });
      return;
    }
    db.ref(`games/${gameId}/results`).orderByChild("timestamp").limitToLast(200)
      .once("value", (snap) => {
        const data = snap.val() || {};
        const results = Object.values(data).sort((a,b) => (b.timestamp||0) - (a.timestamp||0));
        const alpha = results.filter(r => r.choice === "Î±").length;
        const beta = results.filter(r => r.choice === "Î²").length;
        setStats({ alpha, beta, results });
      });
  };

  // ================================================================
  // RENDER HELPERS
  // ================================================================
  const Box = ({ children, style, ...props }) => (
    <div style={{ background: C.SURFACE, borderRadius: 14, padding: 16, border: `1px solid ${C.HEADER}25`, ...style }} {...props}>
      {children}
    </div>
  );

  const Btn = ({ children, primary, style, ...props }) => (
    <button className="btn-press" style={{
      padding: "14px 20px", fontSize: 15, fontWeight: 700, border: "none",
      borderRadius: 12, cursor: "pointer", width: "100%",
      background: primary ? `linear-gradient(135deg, ${C.HEADER}, ${C.BLUE})` : "transparent",
      color: primary ? "white" : C.TEXT2,
      border: primary ? "none" : `1px solid ${C.DIM}40`,
      ...style,
    }} {...props}>{children}</button>
  );

  // ================================================================
  // SCREENS
  // ================================================================

  // ---- HOME ----
  if (screen === "home") return (
    <div style={{ minHeight: "100vh", display: "flex", flexDirection: "column", alignItems: "center", justifyContent: "center", padding: 24, background: `linear-gradient(165deg, ${C.BG} 0%, #0F1A30 50%, #141E35 100%)` }}>
      <div style={{ position: "absolute", inset: 0, backgroundImage: `linear-gradient(${C.HEADER}08 1px, transparent 1px), linear-gradient(90deg, ${C.HEADER}08 1px, transparent 1px)`, backgroundSize: "40px 40px", pointerEvents: "none" }} />

      <div className="fade-up" style={{ position: "relative", zIndex: 1, textAlign: "center", maxWidth: 400, width: "100%" }}>
        <div style={{ width: 60, height: 60, margin: "0 auto 16px", background: `linear-gradient(135deg, ${C.RED}, ${C.GOLD})`, borderRadius: 14, display: "flex", alignItems: "center", justifyContent: "center", fontSize: 26, fontWeight: 800, color: "white", boxShadow: `0 8px 32px ${C.RED}40` }}>
          GT
        </div>

        <h1 style={{ fontSize: 28, fontWeight: 800, color: C.TEXT, letterSpacing: "-0.02em" }}>Game Theory Lab</h1>
        <p style={{ fontSize: 13, color: C.GOLD, letterSpacing: "0.15em", textTransform: "uppercase", fontWeight: 600, margin: "4px 0 0" }}>
          ECON2501 Â· åšå¼ˆè®ºå®éªŒå®¤
        </p>
        <p style={{ fontSize: 12, color: C.DIM, margin: "8px 0 28px" }}>ä¸Šæµ·äº¤é€šå¤§å­¦</p>

        {!firebaseReady && (
          <div style={{ background: `${C.RED}15`, border: `1px solid ${C.RED}40`, borderRadius: 10, padding: 12, marginBottom: 16, fontSize: 12, color: "#FF8A80", textAlign: "left" }}>
            âš ï¸ Firebase æœªé…ç½®ã€‚äººäººå¯¹æˆ˜æ¨¡å¼ä¸å¯ç”¨ã€‚<br/>è¯·æŒ‰ index.html é¡¶éƒ¨è¯´æ˜é…ç½® Firebaseã€‚<br/>AI å¯¹æˆ˜æ¨¡å¼å¯æ­£å¸¸ä½¿ç”¨ã€‚
          </div>
        )}

        <input type="text" placeholder="ä½ çš„åå­— / Your name" value={name}
          onChange={e => setName(e.target.value)}
          style={{ width: "100%", padding: "13px 16px", fontSize: 15, background: C.SURFACE, border: `1px solid ${C.HEADER}40`, borderRadius: 11, color: C.TEXT, outline: "none", marginBottom: 16 }}
          onFocus={e => e.target.style.borderColor = C.GOLD}
          onBlur={e => e.target.style.borderColor = `${C.HEADER}40`}
        />

        <div style={{ display: "flex", gap: 12, marginBottom: 12 }}>
          <button className="btn-press" onClick={() => { setMode("human"); setScreen("play"); }}
            style={{ flex: 1, padding: "18px 12px", fontSize: 14, fontWeight: 700, background: `linear-gradient(135deg, ${C.HEADER}, ${C.BLUE})`, border: "none", borderRadius: 12, color: "white", cursor: "pointer", opacity: firebaseReady ? 1 : 0.4, boxShadow: `0 4px 20px ${C.BLUE}50` }}
            disabled={!firebaseReady}>
            <div style={{ fontSize: 22, marginBottom: 2 }}>ğŸ‘¥</div>
            å¯¹æˆ˜çœŸäºº<br/><span style={{ fontSize: 10, opacity: 0.6, fontWeight: 400 }}>vs Human</span>
          </button>
          <button className="btn-press" onClick={() => { setMode("ai"); setScreen("play"); }}
            style={{ flex: 1, padding: "18px 12px", fontSize: 14, fontWeight: 700, background: "linear-gradient(135deg, #2D1B4E, #1B1040)", border: "1px solid #4A3070", borderRadius: 12, color: "white", cursor: "pointer", boxShadow: "0 4px 20px #2D1B4E50" }}>
            <div style={{ fontSize: 22, marginBottom: 2 }}>ğŸ¤–</div>
            å¯¹æˆ˜AI<br/><span style={{ fontSize: 10, opacity: 0.6, fontWeight: 400 }}>vs AI Agent</span>
          </button>
        </div>

        <div style={{ display: "flex", gap: 10 }}>
          <button className="btn-press" onClick={() => { loadStats(); setScreen("teacher"); }}
            style={{ flex: 1, padding: 11, fontSize: 12, background: "transparent", border: `1px solid ${C.DIM}35`, borderRadius: 10, color: C.TEXT2, cursor: "pointer" }}>
            ğŸ“ æ•™å¸ˆé¢æ¿
          </button>
          <button className="btn-press" onClick={() => { loadStats(); setScreen("history"); }}
            style={{ flex: 1, padding: 11, fontSize: 12, background: "transparent", border: `1px solid ${C.DIM}35`, borderRadius: 10, color: C.TEXT2, cursor: "pointer" }}>
            ğŸ“Š å†å²è®°å½•
          </button>
        </div>
      </div>
    </div>
  );

  // ---- PLAY ----
  if (screen === "play") return (
    <div style={{ minHeight: "100vh", display: "flex", flexDirection: "column", alignItems: "center", justifyContent: "center", padding: 24, background: `linear-gradient(165deg, ${C.BG} 0%, #0F1A30 100%)` }}>
      <button className="btn-press" onClick={() => { setScreen("home"); setWaiting(false); setChoice(null); }}
        style={{ position: "fixed", top: 14, left: 14, background: "none", border: "none", color: C.TEXT2, fontSize: 13, cursor: "pointer" }}>â† è¿”å›</button>

      <div style={{ maxWidth: 400, width: "100%", textAlign: "center" }}>
        <p style={{ fontSize: 11, color: C.GOLD, letterSpacing: "0.12em", textTransform: "uppercase", marginBottom: 4 }}>
          {game.nameCN} Â· Week {game.week}
        </p>

        {!waiting ? (
          <div className="fade-up">
            <h2 style={{ fontSize: 22, fontWeight: 800, color: C.TEXT, marginBottom: 6 }}>é€‰æ‹©ä½ çš„ç­–ç•¥</h2>
            <p style={{ fontSize: 12, color: C.TEXT2, marginBottom: 6 }}>
              {mode === "ai" ? `å¯¹æˆ˜ ${AI[aiType].name}` : "å¯¹æˆ˜çœŸäºº Â· éšæœºåŒ¿åé…å¯¹"}
            </p>
            <p style={{ fontSize: 12, color: C.DIM, marginBottom: 20 }}>{game.descCN}</p>

            {/* AI type selector */}
            {mode === "ai" && (
              <div style={{ display: "flex", gap: 6, flexWrap: "wrap", justifyContent: "center", marginBottom: 20 }}>
                {Object.entries(AI).map(([key, ai]) => (
                  <button key={key} className="btn-press" onClick={() => setAiType(key)} style={{
                    padding: "6px 12px", fontSize: 11, fontWeight: aiType === key ? 700 : 400,
                    background: aiType === key ? `${C.GOLD}18` : "transparent",
                    border: `1px solid ${aiType === key ? C.GOLD : C.DIM + "30"}`,
                    borderRadius: 7, color: aiType === key ? C.GOLD : C.TEXT2, cursor: "pointer",
                  }}>{ai.name}</button>
                ))}
              </div>
            )}

            {/* Payoff matrix toggle */}
            <div style={{ marginBottom: 20 }}>
              <button className="btn-press" onClick={() => setShowMatrix(!showMatrix)}
                style={{ fontSize: 11, color: C.DIM, background: "none", border: `1px solid ${C.DIM}25`, borderRadius: 6, padding: "5px 10px", cursor: "pointer" }}>
                {showMatrix ? "â–² éšè—çŸ©é˜µ" : "â–¼ æŸ¥çœ‹æ”¶ç›ŠçŸ©é˜µ"}
              </button>
              {showMatrix && (
                <div style={{ marginTop: 10, background: C.SURFACE, borderRadius: 10, padding: 12, border: `1px solid ${C.HEADER}25` }}>
                  <table style={{ width: "100%", borderCollapse: "collapse", fontSize: 12 }}>
                    {game.matrix.map((row, i) => (
                      <tr key={i}>
                        {row.map((cell, j) => (
                          <td key={j} style={{
                            padding: "8px 6px", textAlign: "center",
                            fontWeight: i === 0 || j === 0 ? 700 : 400,
                            color: i === 0 || j === 0 ? C.GOLD : C.TEXT,
                            background: (i === 1 && j === 1) ? `${C.RED}12` : (i === 2 && j === 2) ? `${C.GOLD}12` : "transparent",
                            borderRadius: 4,
                          }}>{cell}</td>
                        ))}
                      </tr>
                    ))}
                  </table>
                  <p style={{ fontSize: 10, color: C.DIM, marginTop: 6 }}>æ ¼å¼ï¼šä½ çš„æˆç»©, å¯¹æ–¹æˆç»©</p>
                </div>
              )}
            </div>

            {/* Strategy buttons */}
            <div style={{ display: "flex", gap: 16, justifyContent: "center" }}>
              {game.strategies.map(strat => (
                <button key={strat} className="btn-press" onClick={() => handleChoice(strat)}
                  style={{
                    width: 130, height: 150, fontSize: 44, fontWeight: 800,
                    background: strat === "Î±" ? `linear-gradient(145deg, ${C.ALPHA_BG}, #0F2040)` : `linear-gradient(145deg, ${C.BETA_BG}, #1A1035)`,
                    border: `2px solid ${strat === "Î±" ? C.HEADER : "#4A3070"}`,
                    borderRadius: 18, color: strat === "Î±" ? C.ALPHA_C : C.BETA_C,
                    cursor: "pointer", display: "flex", flexDirection: "column",
                    alignItems: "center", justifyContent: "center",
                    boxShadow: `0 6px 24px ${strat === "Î±" ? C.BLUE : "#2D1B4E"}35`,
                  }}>
                  {strat}
                  <div style={{ fontSize: 11, fontWeight: 400, marginTop: 6, opacity: 0.5, color: C.TEXT2 }}>
                    {strat === "Î±" ? "Alpha" : "Beta"}
                  </div>
                </button>
              ))}
            </div>
          </div>
        ) : (
          <div className="fade-up" style={{ padding: 40 }}>
            <div style={{ width: 44, height: 44, margin: "0 auto 14px", border: `3px solid ${C.DIM}30`, borderTopColor: C.GOLD, borderRadius: "50%", animation: "spin 0.8s linear infinite" }} />
            <h2 style={{ fontSize: 18, color: C.TEXT, marginBottom: 6 }}>
              {mode === "ai" ? `AI æ€è€ƒä¸­${waitDots}` : `ç­‰å¾…é…å¯¹${waitDots}`}
            </h2>
            <p style={{ fontSize: 12, color: C.DIM }}>
              {mode === "ai" ? "æ­£åœ¨è®¡ç®—æœ€ä¼˜ç­–ç•¥..." : "ç­‰å¾…å…¶ä»–åŒå­¦æäº¤é€‰æ‹©..."}
            </p>
            <p style={{ fontSize: 14, color: C.TEXT2, marginTop: 12 }}>
              ä½ é€‰æ‹©äº† <strong style={{ color: choice === "Î±" ? C.ALPHA_C : C.BETA_C, fontSize: 18 }}>{choice}</strong>
            </p>
          </div>
        )}
      </div>
    </div>
  );

  // ---- RESULT ----
  if (screen === "result" && result) {
    const win = result.myPay > result.oppPay;
    const tie = result.myPay === result.oppPay;

    return (
      <div style={{ minHeight: "100vh", display: "flex", flexDirection: "column", alignItems: "center", justifyContent: "center", padding: 24, background: win ? `linear-gradient(165deg, #0B200F, #0F1A30)` : tie ? `linear-gradient(165deg, #1A1A0B, #0F1A30)` : `linear-gradient(165deg, #200B0B, #0F1A30)` }}>
        <div style={{ maxWidth: 400, width: "100%", textAlign: "center" }}>

          <div className="fade-up" style={{ fontSize: 44, marginBottom: 4 }}>
            {win ? "ğŸ‰" : tie ? "ğŸ¤" : "ğŸ˜¤"}
          </div>
          <h2 className="fade-up fade-up-1" style={{ fontSize: 24, fontWeight: 800, color: C.TEXT, marginBottom: 2 }}>
            {result.label}
          </h2>
          <p className="fade-up fade-up-1" style={{ fontSize: 12, color: C.TEXT2, marginBottom: 20 }}>
            vs {result.oppName}
          </p>

          {/* Cards */}
          <div className="fade-up fade-up-2" style={{ display: "flex", gap: 12, marginBottom: 20 }}>
            <Box style={{ flex: 1, textAlign: "center" }}>
              <div style={{ fontSize: 10, color: C.DIM, marginBottom: 2 }}>ä½ çš„é€‰æ‹©</div>
              <div style={{ fontSize: 32, fontWeight: 800, color: result.myChoice === "Î±" ? C.ALPHA_C : C.BETA_C }}>{result.myChoice}</div>
              <div style={{ fontSize: 18, fontWeight: 700, color: result.myPay >= 0 ? C.GREEN : C.RED, marginTop: 2 }}>
                {result.myPay > 0 ? "+" : ""}{result.myPay}
              </div>
            </Box>
            <Box style={{ flex: 1, textAlign: "center" }}>
              <div style={{ fontSize: 10, color: C.DIM, marginBottom: 2 }}>å¯¹æ–¹é€‰æ‹©</div>
              <div style={{ fontSize: 32, fontWeight: 800, color: result.oppChoice === "Î±" ? C.ALPHA_C : C.BETA_C }}>{result.oppChoice}</div>
              <div style={{ fontSize: 18, fontWeight: 700, color: result.oppPay >= 0 ? C.GREEN : C.RED, marginTop: 2 }}>
                {result.oppPay > 0 ? "+" : ""}{result.oppPay}
              </div>
            </Box>
          </div>

          {/* Lesson */}
          <div className="fade-up fade-up-3" style={{ background: `${C.GOLD}0C`, border: `1px solid ${C.GOLD}25`, borderRadius: 12, padding: 14, marginBottom: 20, textAlign: "left" }}>
            <div style={{ fontSize: 12, fontWeight: 700, color: C.GOLD, marginBottom: 4 }}>
              ğŸ’¡ {game.lessonTitle}
            </div>
            <div style={{ fontSize: 12, color: C.TEXT2, lineHeight: 1.65 }}>
              {game.lessons[result.key]}
            </div>
          </div>

          {/* AI history */}
          {mode === "ai" && aiHistory.length > 1 && (
            <div style={{ marginBottom: 16 }}>
              <div style={{ fontSize: 11, color: C.DIM, marginBottom: 6 }}>å¯¹æˆ˜è®°å½• ({aiHistory.length} å±€)</div>
              <div style={{ display: "flex", gap: 3, justifyContent: "center", flexWrap: "wrap" }}>
                {aiHistory.map((h, i) => (
                  <div key={i} style={{
                    width: 28, height: 28, borderRadius: 6, fontSize: 10, fontWeight: 700,
                    display: "flex", alignItems: "center", justifyContent: "center",
                    background: h.mine === "Î±" && h.opp === "Î±" ? `${C.RED}20` : h.mine === "Î²" && h.opp === "Î²" ? `${C.GREEN}20` : `${C.GOLD}15`,
                    color: h.mine === "Î±" && h.opp === "Î±" ? C.RED : h.mine === "Î²" && h.opp === "Î²" ? C.GREEN : C.GOLD,
                  }}>{h.mine}{h.opp}</div>
                ))}
              </div>
            </div>
          )}

          <div style={{ display: "flex", gap: 10 }}>
            <Btn primary onClick={playAgain}>å†æ¥ä¸€å±€</Btn>
            <Btn onClick={() => { setChoice(null); setResult(null); setScreen("home"); }}>è¿”å›é¦–é¡µ</Btn>
          </div>
        </div>
      </div>
    );
  }

  // ---- TEACHER ----
  if (screen === "teacher") {
    const total = stats.alpha + stats.beta;
    const aR = total > 0 ? Math.round(stats.alpha / total * 100) : 0;
    const bR = total > 0 ? Math.round(stats.beta / total * 100) : 0;

    return (
      <div style={{ minHeight: "100vh", padding: 24, background: `linear-gradient(165deg, ${C.BG}, #0F1A30)` }}>
        <div style={{ maxWidth: 460, margin: "0 auto" }}>
          <button className="btn-press" onClick={() => setScreen("home")} style={{ background: "none", border: "none", color: C.TEXT2, fontSize: 13, cursor: "pointer", marginBottom: 14 }}>â† è¿”å›</button>

          <h2 style={{ fontSize: 22, fontWeight: 800, color: C.TEXT, marginBottom: 2 }}>ğŸ“ æ•™å¸ˆé¢æ¿</h2>
          <p style={{ fontSize: 12, color: C.TEXT2, marginBottom: 20 }}>{game.nameCN} Â· å®æ—¶è¯¾å ‚ç»Ÿè®¡</p>

          <div style={{ display: "flex", gap: 12, marginBottom: 16 }}>
            <Box style={{ flex: 1, textAlign: "center" }}>
              <div style={{ fontSize: 32, fontWeight: 800, color: C.ALPHA_C }}>{aR}%</div>
              <div style={{ fontSize: 12, color: C.TEXT2 }}>é€‰æ‹© Î±</div>
              <div style={{ fontSize: 10, color: C.DIM }}>{stats.alpha}/{total} äºº</div>
            </Box>
            <Box style={{ flex: 1, textAlign: "center" }}>
              <div style={{ fontSize: 32, fontWeight: 800, color: C.BETA_C }}>{bR}%</div>
              <div style={{ fontSize: 12, color: C.TEXT2 }}>é€‰æ‹© Î²</div>
              <div style={{ fontSize: 10, color: C.DIM }}>{stats.beta}/{total} äºº</div>
            </Box>
          </div>

          {/* Bar */}
          <Box style={{ marginBottom: 16 }}>
            <div style={{ fontSize: 11, color: C.DIM, marginBottom: 6 }}>ç­–ç•¥åˆ†å¸ƒ</div>
            <div style={{ display: "flex", height: 28, borderRadius: 8, overflow: "hidden", background: `${C.DIM}20` }}>
              <div style={{ width: `${aR}%`, background: `linear-gradient(90deg, #3A7BD5, ${C.ALPHA_C})`, transition: "width 0.6s ease", display: "flex", alignItems: "center", justifyContent: "center", fontSize: 11, fontWeight: 700, color: "white" }}>
                {aR > 12 ? `Î± ${aR}%` : ""}
              </div>
              <div style={{ width: `${bR}%`, background: `linear-gradient(90deg, #7B4FBF, ${C.BETA_C})`, transition: "width 0.6s ease", display: "flex", alignItems: "center", justifyContent: "center", fontSize: 11, fontWeight: 700, color: "white" }}>
                {bR > 12 ? `Î² ${bR}%` : ""}
              </div>
            </div>
          </Box>

          {/* Polak comparison */}
          <Box style={{ background: `${C.GOLD}08`, border: `1px solid ${C.GOLD}20`, marginBottom: 16 }}>
            <div style={{ fontSize: 12, fontWeight: 700, color: C.GOLD, marginBottom: 6 }}>ğŸ“– å¯¹æ¯” Polak (Yale 2007)</div>
            <div style={{ fontSize: 11, color: C.TEXT2, lineHeight: 1.6 }}>
              è€¶é²è¯¾å ‚ï¼š~85% é€‰ Î±, ~15% é€‰ Î²<br/>
              æ™®é€šäººå®éªŒï¼š~70% é€‰ Î±, ~30% é€‰ Î²<br/><br/>
              <strong style={{ color: C.TEXT }}>ä½ çš„è¯¾å ‚ï¼š{aR}% Î±, {bR}% Î² ({total}äºº)</strong><br/>
              {total === 0 ? "è¿˜æ²¡æœ‰æ•°æ®â€”â€”è®©å­¦ç”Ÿå¼€å§‹æ¸¸æˆå§ï¼" :
               aR > 75 ? "ä½ çš„å­¦ç”Ÿå’Œè€¶é²å­¦ç”Ÿä¸€æ ·ã€Œç†æ€§ã€ï¼ˆè‡ªç§ï¼ŸğŸ˜„ï¼‰" :
               bR > 50 ? "ä½ çš„å­¦ç”Ÿæ›´å€¾å‘åˆä½œâ€”â€”æ˜¯å¤©ä½¿è¿˜æ˜¯è¿˜æ²¡å­¦åˆ°å ä¼˜ç­–ç•¥ï¼Ÿ" :
               "æœ‰è¶£çš„åˆ†å¸ƒï¼è¯¾å ‚è®¨è®ºçš„å¥½ç´ æã€‚"}
            </div>
          </Box>

          {/* Recent results */}
          {stats.results.length > 0 && (
            <Box>
              <div style={{ fontSize: 11, color: C.DIM, marginBottom: 8 }}>æœ€è¿‘ç»“æœ</div>
              {stats.results.slice(0, 15).map((r, i) => (
                <div key={i} style={{ display: "flex", justifyContent: "space-between", alignItems: "center", padding: "6px 0", borderBottom: i < 14 ? `1px solid ${C.DIM}15` : "none", fontSize: 12 }}>
                  <span style={{ color: C.TEXT }}>{r.player}</span>
                  <span style={{ color: C.TEXT2 }}>
                    <span style={{ color: r.choice === "Î±" ? C.ALPHA_C : C.BETA_C, fontWeight: 700 }}>{r.choice}</span>
                    {" vs "}
                    <span style={{ color: r.oppChoice === "Î±" ? C.ALPHA_C : C.BETA_C, fontWeight: 700 }}>{r.oppChoice}</span>
                  </span>
                  <span style={{ color: r.payoff >= 0 ? C.GREEN : C.RED, fontWeight: 700 }}>
                    {r.payoff > 0 ? "+" : ""}{r.payoff}
                  </span>
                </div>
              ))}
            </Box>
          )}

          <button className="btn-press" onClick={loadStats}
            style={{ width: "100%", marginTop: 12, padding: 11, fontSize: 12, background: "transparent", border: `1px solid ${C.DIM}30`, borderRadius: 10, color: C.TEXT2, cursor: "pointer" }}>
            ğŸ”„ åˆ·æ–°æ•°æ®
          </button>
        </div>
      </div>
    );
  }

  // ---- HISTORY ----
  if (screen === "history") return (
    <div style={{ minHeight: "100vh", padding: 24, background: `linear-gradient(165deg, ${C.BG}, #0F1A30)` }}>
      <div style={{ maxWidth: 460, margin: "0 auto" }}>
        <button className="btn-press" onClick={() => setScreen("home")} style={{ background: "none", border: "none", color: C.TEXT2, fontSize: 13, cursor: "pointer", marginBottom: 14 }}>â† è¿”å›</button>
        <h2 style={{ fontSize: 22, fontWeight: 800, color: C.TEXT, marginBottom: 16 }}>ğŸ“Š å†å²è®°å½•</h2>
        {stats.results.length === 0 ? (
          <p style={{ color: C.DIM, fontSize: 13 }}>è¿˜æ²¡æœ‰è®°å½•ã€‚å»ç©ä¸€å±€å§ï¼</p>
        ) : stats.results.map((r, i) => (
          <Box key={i} style={{ marginBottom: 8, display: "flex", justifyContent: "space-between", alignItems: "center" }}>
            <div>
              <div style={{ fontSize: 13, fontWeight: 600, color: C.TEXT }}>{r.player}</div>
              <div style={{ fontSize: 10, color: C.DIM }}>
                {r.choice} vs {r.opponent}({r.oppChoice})
              </div>
            </div>
            <div style={{ fontSize: 15, fontWeight: 700, color: r.payoff >= 0 ? C.GREEN : C.RED }}>
              {r.payoff > 0 ? "+" : ""}{r.payoff}
            </div>
          </Box>
        ))}
      </div>
    </div>
  );

  return null;
}

ReactDOM.render(<App />, document.getElementById("app"));
</script>
</body>
</html>
