<!DOCTYPE html>
<html lang="zh-CN">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<title>ECON2501 Game Theory Lab | åšå¼ˆè®ºå®éªŒå®¤</title>
<style>
  @import url('https://fonts.googleapis.com/css2?family=Noto+Serif+SC:wght@400;600;700;900&display=swap');
  * { box-sizing: border-box; margin: 0; padding: 0; }
  html, body { height: 100%; overflow-x: hidden; }
  body {
    font-family: 'Georgia', 'Noto Serif SC', serif;
    -webkit-font-smoothing: antialiased;
    background: #0B1120;
    color: #E8ECF4;
  }
  input::placeholder { color: #5A6478; }
  button { font-family: 'Georgia', 'Noto Serif SC', serif; }
  @keyframes spin { to { transform: rotate(360deg); } }
  @keyframes fadeUp { from { opacity:0; transform:translateY(20px); } to { opacity:1; transform:translateY(0); } }
  @keyframes pulse { 0%,100% { opacity:1; } 50% { opacity:0.5; } }
  @keyframes confetti {
    0% { opacity:1; transform: translate(0,0) rotate(0deg) scale(1); }
    100% { opacity:0; transform: translate(var(--tx), var(--ty)) rotate(720deg) scale(0.3); }
  }
  .fade-up { animation: fadeUp 0.5s ease-out forwards; }
  .fade-up-1 { animation-delay: 0.1s; opacity: 0; }
  .fade-up-2 { animation-delay: 0.2s; opacity: 0; }
  .fade-up-3 { animation-delay: 0.3s; opacity: 0; }
  .btn-press { transition: transform 0.12s ease; }
  .btn-press:active { transform: scale(0.95); }
</style>
</head>
<body>
<div id="app"></div>

<!-- Firebase SDK (compat for simplicity) -->
<script src="https://www.gstatic.com/firebasejs/10.12.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.12.0/firebase-database-compat.js"></script>

<!-- React -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/react/18.2.0/umd/react.production.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/react-dom/18.2.0/umd/react-dom.production.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/babel-standalone/7.23.9/babel.min.js"></script>

<script type="text/babel">
const { useState, useEffect, useRef, useCallback } = React;

// ================================================================
// ğŸ”¥ FIREBASE CONFIG â€” Replace with your own!
// ================================================================
// Steps:
// 1. Go to https://console.firebase.google.com
// 2. Click "Add project" â†’ name it "game-theory-lab" â†’ Create
// 3. Click "Build" â†’ "Realtime Database" â†’ "Create Database" â†’ Start in TEST mode
// 4. Go to Project Settings (gear icon) â†’ scroll to "Your apps" â†’ click "</>" (Web)
// 5. Register app â†’ copy the firebaseConfig object â†’ paste below
// ================================================================

const firebaseConfig = {
  apiKey: "AIzaSyCPofplryBpIRHJyidUvej1kEj_7f_EFNQ",
  authDomain: "game-theory-36dc1.firebaseapp.com",
  databaseURL: "https://game-theory-36dc1-default-rtdb.asia-southeast1.firebasedatabase.app",
  projectId: "game-theory-36dc1",
  storageBucket: "game-theory-36dc1.firebasestorage.app",
  messagingSenderId: "655138906576",
  appId: "1:655138906576:web:1f8929a514cb2772e259d5",
  measurementId: "G-5VQJQBED35"
};

let db = null;
let firebaseReady = false;
try {
  if (firebaseConfig.apiKey) {
    firebase.initializeApp(firebaseConfig);
    db = firebase.database();
    firebaseReady = true;
  }
} catch (e) {
  console.warn("Firebase not configured:", e);
}

// ================================================================
// CONSTANTS
// ================================================================
const C = {
  BLUE: "#1F3864", HEADER: "#2E5A88", RED: "#C00000",
  GOLD: "#D4A84B", BG: "#0B1120", CARD: "#131B2E",
  SURFACE: "#1A2540", TEXT: "#E8ECF4", TEXT2: "#8B95A8",
  DIM: "#5A6478", GREEN: "#4CAF50", PURPLE: "#B08DE0",
  ALPHA_BG: "#1A3050", BETA_BG: "#2A1A40",
  ALPHA_C: "#5BA8E0", BETA_C: "#B08DE0",
};

// ================================================================
// GAME DEFINITIONS
// ================================================================
// â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
// â”‚  TO ADD A NEW GAME EACH WEEK:                           â”‚
// â”‚  1. Copy the grade_game template below                  â”‚
// â”‚  2. Change the id, name, strategies, payoffs, etc.      â”‚
// â”‚  3. Save and re-upload to GitHub                        â”‚
// â”‚  That's it! The app auto-detects all games in GAMES.    â”‚
// â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
const GAMES = {
  grade_game: {
    id: "grade_game", name: "The Grade Game", nameCN: "æˆç»©åšå¼ˆ", week: 1,
    desc: "Choose Î± or Î². Your grade depends on both choices.",
    descCN: "é€‰æ‹© Î± æˆ– Î²ã€‚ä½ çš„æˆç»©å–å†³äºåŒæ–¹çš„é€‰æ‹©ã€‚",
    // ---- INTRO / STORY ----
    intro: {
      emoji: "ğŸ“",
      story: "ä½ æ­£åœ¨å‚åŠ ä¸€é—¨è¯¾ç¨‹çš„è€ƒè¯•ã€‚æ•™æˆæœ‰ä¸€ä¸ªç‰¹åˆ«çš„è¯„åˆ†è§„åˆ™ï¼šä½ çš„æˆç»©ä¸ä»…å–å†³äºä½ è‡ªå·±çš„é€‰æ‹©ï¼Œè¿˜å–å†³äºå’Œä½ éšæœºé…å¯¹çš„å¦ä¸€ä¸ªåŒå­¦çš„é€‰æ‹©ã€‚",
      storySub: "You're in a course with a special grading rule: your grade depends on both YOUR choice and your randomly paired partner's choice.",
      rules: [
        { strats: "ä½ é€‰ Î±ï¼Œå¯¹æ–¹é€‰ Î±", outcome: "éƒ½æ‹¿ Bâˆ’", icon: "ğŸ˜", en: "Both choose Î± â†’ Both get Bâˆ’" },
        { strats: "ä½ é€‰ Î±ï¼Œå¯¹æ–¹é€‰ Î²", outcome: "ä½ æ‹¿ Aï¼Œå¯¹æ–¹æ‹¿ C", icon: "ğŸ˜ˆ", en: "You Î±, they Î² â†’ You get A, they get C" },
        { strats: "ä½ é€‰ Î²ï¼Œå¯¹æ–¹é€‰ Î±", outcome: "ä½ æ‹¿ Cï¼Œå¯¹æ–¹æ‹¿ A", icon: "ğŸ˜¢", en: "You Î², they Î± â†’ You get C, they get A" },
        { strats: "ä½ é€‰ Î²ï¼Œå¯¹æ–¹é€‰ Î²", outcome: "éƒ½æ‹¿ B+", icon: "ğŸ¤", en: "Both choose Î² â†’ Both get B+" },
      ],
      question: "ä½ ä¼šæ€ä¹ˆé€‰ï¼Ÿä¿¡ä»»é™Œç”Ÿäººï¼Œè¿˜æ˜¯åªé¡¾è‡ªå·±ï¼Ÿ",
      questionEN: "What will you choose? Trust a stranger, or look out for yourself?",
      hint: "æç¤ºï¼šæƒ³æƒ³çœ‹ï¼Œæ— è®ºå¯¹æ–¹æ€ä¹ˆé€‰ï¼Œä½ é€‰å“ªä¸ªæ€»æ˜¯æ›´å¥½ï¼Ÿè¿˜æ˜¯è¯´...è¿™å–å†³äºä½ åœ¨ä¹ä»€ä¹ˆï¼Ÿ",
    },
    strategies: ["Î±", "Î²"],
    stratLabels: { "Î±": "Alpha", "Î²": "Beta" },
    stratColors: { "Î±": "#5BA8E0", "Î²": "#B08DE0" },
    payoffs: {
      "Î±,Î±": { label: "Bâˆ’, Bâˆ’", p1: 0, p2: 0 },
      "Î±,Î²": { label: "A, C",   p1: 3, p2: -1 },
      "Î²,Î±": { label: "C, A",   p1: -1, p2: 3 },
      "Î²,Î²": { label: "B+, B+", p1: 1, p2: 1 },
    },
    matrix: [
      ["", "å¯¹æ–¹ Î±", "å¯¹æ–¹ Î²"],
      ["ä½  Î±", "Bâˆ’, Bâˆ’", "A, C"],
      ["ä½  Î²", "C, A", "B+, B+"],
    ],
    lessons: {
      "Î±,Î±": "ä½ ä»¬éƒ½é€‰äº† Î± â€”â€” éƒ½æ‹¿äº† Bâˆ’ã€‚å¦‚æœä½ ä»¬éƒ½åªåœ¨ä¹è‡ªå·±çš„æˆç»©ï¼Œè¿™å°±æ˜¯ç»å…¸çš„å›šå¾’å›°å¢ƒï¼šÎ±æ˜¯å ä¼˜ç­–ç•¥ï¼Œä½†åŒæ–¹çš„ã€Œç†æ€§ã€é€‰æ‹©åè€Œå¯¼è‡´äº†åŒè¾“ã€‚ä¸è¿‡ï¼Œå¦‚æœä½ ä»¬åœ¨ä¹å…¬å¹³å‘¢ï¼Ÿé‚£è¿™å¯èƒ½æ˜¯å®Œå…¨ä¸åŒçš„åšå¼ˆå“¦ã€‚\n\nYou both chose Î± â€” both got Bâˆ’. If you only care about your own grade, this is a classic Prisoner's Dilemma: Î± dominates, but \"rational\" play leads to a lose-lose. But what if you care about fairness? Then it might be a completely different game.",
      "Î±,Î²": "ä½ æ‹¿äº†Aï¼Œå¯¹æ–¹æ‹¿äº†Cã€‚ä»æˆç»©è§’åº¦çœ‹ï¼Œä½ èµ¢äº†ğŸ‰ã€‚ä½†ä½ ä¼šä¸ä¼šæœ‰ä¸€ç‚¹ç‚¹ä¸å¥½æ„æ€ï¼Ÿå¦‚æœä½ ä¼šâ€”â€”è¯´æ˜ä½ çš„åå¥½ä¸åªæ˜¯ã€Œæˆç»©è¶Šé«˜è¶Šå¥½ã€ï¼Œé‚£è¿™ä¸ªåšå¼ˆå¯¹ä½ æ¥è¯´å°±å®Œå…¨ä¸åŒäº†ã€‚\n\nYou got A, they got C. Grade-wise, you won ğŸ‰. But do you feel a little guilty? If so â€” your preferences go beyond just \"higher grade = better\", and that changes the entire game for you.",
      "Î²,Î±": "ä½ é€‰äº†Î²ï¼Œå¯¹æ–¹é€‰äº†Î±ï¼Œä½ æ‹¿äº†CğŸ˜…ã€‚ä½†æƒ³æƒ³ï¼šä½ ä¸ºä»€ä¹ˆé€‰Î²ï¼Ÿæ˜¯ä¿¡ä»»å¯¹æ–¹ä¼šåˆä½œï¼Ÿè¿˜æ˜¯ä½ è§‰å¾—B+å¯¹åŒæ–¹éƒ½å¥½ï¼Ÿä½ çš„é€‰æ‹©æš´éœ²äº†ä½ çš„åå¥½â€”â€”è€Œåå¥½å†³å®šäº†è¿™æ˜¯ä»€ä¹ˆåšå¼ˆã€‚\n\nYou chose Î², they chose Î± â€” you got C ğŸ˜…. But think: why did you pick Î²? Did you trust them to cooperate? Or did you think B+ for both is the right outcome? Your choice reveals your preferences â€” and preferences determine what game you're actually playing.",
      "Î²,Î²": "ä½ ä»¬éƒ½é€‰äº†Î²ï¼Œéƒ½æ‹¿äº†B+ ğŸ¤ ä¸é”™ï¼ä½†æƒ³ä¸€æƒ³ï¼šå¦‚æœä½ åªåœ¨ä¹è‡ªå·±çš„æˆç»©ï¼Œé€‰Î±æœ¬å¯ä»¥æ‹¿Aã€‚ä½ æ²¡é€‰ï¼Œæ˜¯å› ä¸ºä½ åœ¨ä¹å…¬å¹³ï¼Ÿè¿˜æ˜¯æ²¡æ³¨æ„åˆ°ï¼Ÿä¸åŒçš„åŸå› æ„å‘³ç€ä¸åŒçš„åšå¼ˆã€‚\n\nYou both chose Î² â€” both got B+ ğŸ¤ Nice! But think: if you only cared about your own grade, Î± could have gotten you an A. You didn't pick it â€” is that because you care about fairness? Or did you not notice? Different reasons mean different games.",
    },
    lessonTitle: "å…³é”®é—®é¢˜ï¼šä½ åœ¨ä¹ä»€ä¹ˆï¼ŸWhat matters is: what do you care about?",
  },
};

// AI â€” Claude via Anthropic API
async function getClaudeChoice(game, history) {
  try {
    const historyStr = history.length > 0
      ? "Previous rounds: " + history.map((h, i) => `Round ${i+1}: human=${h.mine}, AI=${h.opp}`).join("; ")
      : "This is the first round.";

    const response = await fetch("https://api.anthropic.com/v1/messages", {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({
        model: "claude-sonnet-4-20250514",
        max_tokens: 1000,
        messages: [{
          role: "user",
          content: `You are playing a game theory game called "${game.name}" against a human student.
Available strategies: ${game.strategies.join(", ")}

OUTCOME matrix (grades, NOT payoffs):
  Î±,Î± â†’ Bâˆ’, Bâˆ’
  Î±,Î² â†’ A, C  
  Î²,Î± â†’ C, A
  Î²,Î² â†’ B+, B+

IMPORTANT: These are OUTCOMES (grades), not payoffs. The payoffs depend on PREFERENCES. 
- If you are a "selfish" player (evil git) who only cares about your own grade: A=3, B+=1, Bâˆ’=0, C=âˆ’1 â†’ Î± is dominant.
- If you are an "indignant angel" who feels guilt getting A while partner gets C, or anger getting C while partner gets A â†’ the game changes completely, and there may be no dominant strategy.
- The game theory lesson here is: the same outcomes + different preferences = completely different games.

${historyStr}

You must decide what kind of player you are and choose accordingly. Be creative â€” maybe you're selfish, maybe you care about fairness, maybe you're vengeful. Your personality can evolve across rounds.

Respond in EXACTLY this JSON format, nothing else:
{"choice":"Î± or Î²","reasoning_cn":"2-4å¥ä¸­æ–‡ã€‚å…ˆè¯´æ˜ä½ çš„åå¥½/æ€§æ ¼ï¼ˆä½ åœ¨ä¹ä»€ä¹ˆï¼‰ï¼Œç„¶åè§£é‡Šè¿™å¦‚ä½•å½±å“ä½ çš„ç­–ç•¥é€‰æ‹©ã€‚å¼•ç”¨åšå¼ˆè®ºæ¦‚å¿µã€‚","reasoning_en":"2-4 sentences in English. First state your preferences/personality, then explain how this affects your strategy. Reference game theory concepts."}`
        }]
      })
    });
    const data = await response.json();
    const text = (data.content?.[0]?.text || "").trim();
    try {
      const clean = text.replace(/```json|```/g, "").trim();
      const parsed = JSON.parse(clean);
      if (game.strategies.includes(parsed.choice)) {
        return { choice: parsed.choice, reasoningCN: parsed.reasoning_cn, reasoningEN: parsed.reasoning_en };
      }
    } catch {}
    // Fallback: try to find strategy in raw text
    for (const s of game.strategies) {
      if (text.includes(s)) return { choice: s, reasoningCN: "AIé€‰æ‹©äº†ç­–ç•¥ " + s, reasoningEN: "AI chose strategy " + s };
    }
    return { choice: game.strategies[0], reasoningCN: "ï¼ˆåˆ†æä¸å¯ç”¨ï¼‰", reasoningEN: "(Analysis unavailable)" };
  } catch (e) {
    console.error("Claude API error:", e);
    const fallback = game.strategies[Math.floor(Math.random() * game.strategies.length)];
    return { choice: fallback, reasoningCN: "ï¼ˆAPIè¿æ¥å¤±è´¥ï¼Œéšæœºé€‰æ‹©ï¼‰", reasoningEN: "(API connection failed, random choice)" };
  }
}

// ================================================================
// FIREBASE HELPERS
// ================================================================
function generateId() {
  return Date.now().toString(36) + Math.random().toString(36).slice(2,8);
}

// ================================================================
// APP COMPONENT
// ================================================================
function App() {
  const [screen, setScreen] = useState("home"); // home | intro | play | result | history | teacher
  const [name, setName] = useState(() => {
    try { return localStorage.getItem("gt_name") || ""; } catch { return ""; }
  });
  const [studentId, setStudentId] = useState(() => {
    try { return localStorage.getItem("gt_sid") || ""; } catch { return ""; }
  });
  const [sessionCode, setSessionCode] = useState("");
  const [section, setSection] = useState("");
  const [mode, setMode] = useState("human");
  const [aiType, setAiType] = useState("random");
  const [waiting, setWaiting] = useState(false);
  const [choice, setChoice] = useState(null);
  const [result, setResult] = useState(null);
  const [showMatrix, setShowMatrix] = useState(false);
  const [aiHistory, setAiHistory] = useState([]);
  const [stats, setStats] = useState({ alpha: 0, beta: 0, results: [] });
  const [waitDots, setWaitDots] = useState("");

  const gameId = "grade_game";
  const game = GAMES[gameId];
  const myId = useRef(generateId());
  const listenersRef = useRef([]);

  // Save name & student ID
  useEffect(() => {
    try { if (name) localStorage.setItem("gt_name", name); } catch {}
  }, [name]);
  useEffect(() => {
    try { if (studentId) localStorage.setItem("gt_sid", studentId); } catch {}
  }, [studentId]);

  // Waiting dots animation
  useEffect(() => {
    if (!waiting) return;
    const iv = setInterval(() => setWaitDots(d => d.length >= 3 ? "" : d + "."), 500);
    return () => clearInterval(iv);
  }, [waiting]);

  // Cleanup firebase listeners on unmount
  useEffect(() => {
    return () => listenersRef.current.forEach(off => off());
  }, []);

  // ---- HUMAN MATCHING via Firebase (Batch mode) ----
  // Students submit, wait for matching window, then get randomly paired
  const [countdown, setCountdown] = useState(0);

  const submitHuman = async (myChoice) => {
    if (!firebaseReady) {
      alert("Firebase æœªé…ç½®ï¼è¯·æŒ‰ç…§è¯´æ˜è®¾ç½® Firebaseã€‚\nFirebase not configured! Follow setup instructions.");
      return;
    }
    setChoice(myChoice);
    setWaiting(true);

    // Submit to pending pool
    const myRef = db.ref(`games/${gameId}/pending/${myId.current}`);
    await myRef.set({
      name: name || "åŒ¿å",
      studentId: studentId || "",
      choice: myChoice,
      timestamp: firebase.database.ServerValue.TIMESTAMP,
    });

    // Start countdown (30 seconds)
    let timeLeft = 30;
    setCountdown(timeLeft);
    const timer = setInterval(() => {
      timeLeft--;
      setCountdown(timeLeft);
      if (timeLeft <= 0) clearInterval(timer);
    }, 1000);

    // Only start listening for match AFTER 30 seconds
    // This ensures everyone waits the full countdown
    setTimeout(() => {
      const matchRef = db.ref(`games/${gameId}/matches/${myId.current}`);
      const onMatch = matchRef.on("value", (snap) => {
        const match = snap.val();
        if (!match) return;
        matchRef.off("value", onMatch);
        const key = `${myChoice},${match.opponentChoice}`;
        const po = game.payoffs[key];
        const res = {
          myChoice, oppChoice: match.opponentChoice,
          oppName: match.opponentName,
          label: po.label, myPay: po.p1, oppPay: po.p2, key,
        };
        setResult(res);
        setWaiting(false);
        setCountdown(0);
        setScreen("result");

        // Record to results log
        db.ref(`games/${gameId}/results`).push({
          player: name || "åŒ¿å", studentId: studentId || "",
          choice: myChoice,
          opponent: match.opponentName, oppChoice: match.opponentChoice,
          payoff: po.p1, timestamp: firebase.database.ServerValue.TIMESTAMP,
        });
      });
      listenersRef.current.push(() => matchRef.off("value", onMatch));
    }, 30000);

    // After 30 seconds, try to match everyone
    setTimeout(async () => {
      // Check if already matched
      const myMatchSnap = await db.ref(`games/${gameId}/matches/${myId.current}`).once("value");
      if (myMatchSnap.val()) return; // Already matched

      // Read all pending submissions
      const snap = await db.ref(`games/${gameId}/pending`).once("value");
      const pending = snap.val();
      if (!pending) {
        matchRef.off("value", onMatch);
        setWaiting(false);
        setCountdown(0);
        alert("æ²¡æœ‰å…¶ä»–äººæäº¤ï¼Œè¯·ç¨åé‡è¯•ã€‚\nNo other submissions. Please try again.");
        setScreen("play");
        setChoice(null);
        return;
      }

      // Get all other players
      const others = Object.entries(pending).filter(([id]) => id !== myId.current);

      if (others.length === 0) {
        matchRef.off("value", onMatch);
        myRef.remove();
        setWaiting(false);
        setCountdown(0);
        alert("æ²¡æœ‰æ‰¾åˆ°å¯¹æ‰‹ï¼Œè¯·ç­‰å…¶ä»–åŒå­¦ä¹Ÿæäº¤åé‡è¯•ã€‚\nNo opponent found. Wait for classmates to submit and try again.");
        setScreen("play");
        setChoice(null);
        return;
      }

      // Pick a random opponent (with replacement â€” don't remove them from pending)
      // This way odd-numbered students still get matched
      const randomIdx = Math.floor(Math.random() * others.length);
      const [oppId, oppData] = others[randomIdx];

      // Create match â€” only remove SELF from pending, not opponent
      // Opponent stays available for other unmatched students
      const updates = {};
      updates[`games/${gameId}/pending/${myId.current}`] = null;
      updates[`games/${gameId}/matches/${myId.current}`] = {
        opponentChoice: oppData.choice,
        opponentName: oppData.name,
      };

      // Also try to match the opponent with us (if they haven't been matched yet)
      const oppMatchSnap = await db.ref(`games/${gameId}/matches/${oppId}`).once("value");
      if (!oppMatchSnap.val()) {
        updates[`games/${gameId}/pending/${oppId}`] = null;
        updates[`games/${gameId}/matches/${oppId}`] = {
          opponentChoice: myChoice,
          opponentName: name || "åŒ¿å",
        };
      }

      try {
        await db.ref().update(updates);
      } catch (e) {
        console.log("Match conflict, retrying...");
      }
    }, 30000);
  };

  // ---- AI PLAY ----
  const submitAI = async (myChoice) => {
    setChoice(myChoice);
    setWaiting(true);
    const aiResult = await getClaudeChoice(game, aiHistory);
    const key = `${myChoice},${aiResult.choice}`;
    const po = game.payoffs[key];
    const res = {
      myChoice, oppChoice: aiResult.choice,
      oppName: "Claude AI",
      label: po.label, myPay: po.p1, oppPay: po.p2, key,
      aiReasoningCN: aiResult.reasoningCN,
      aiReasoningEN: aiResult.reasoningEN,
    };
    setAiHistory(prev => [...prev, { mine: myChoice, opp: aiResult.choice }]);
    setResult(res);
    setWaiting(false);
    setScreen("result");
  };

  const handleChoice = (c) => {
    if (mode === "ai") submitAI(c);
    else submitHuman(c);
  };

  const playAgain = () => {
    myId.current = generateId();
    setChoice(null); setResult(null); setScreen("play");
  };

  // ---- TEACHER STATS ----
  const loadStats = () => {
    if (!firebaseReady) {
      setStats({ alpha: 0, beta: 0, results: [] });
      return;
    }
    db.ref(`games/${gameId}/results`).orderByChild("timestamp").limitToLast(200)
      .once("value", (snap) => {
        const data = snap.val() || {};
        const results = Object.values(data).sort((a,b) => (b.timestamp||0) - (a.timestamp||0));
        const alpha = results.filter(r => r.choice === "Î±").length;
        const beta = results.filter(r => r.choice === "Î²").length;
        setStats({ alpha, beta, results });
      });
  };

  // ================================================================
  // RENDER HELPERS
  // ================================================================
  const Box = ({ children, style, ...props }) => (
    <div style={{ background: C.SURFACE, borderRadius: 14, padding: 16, border: `1px solid ${C.HEADER}25`, ...style }} {...props}>
      {children}
    </div>
  );

  const Btn = ({ children, primary, style, ...props }) => (
    <button className="btn-press" style={{
      padding: "14px 20px", fontSize: 15, fontWeight: 700, border: "none",
      borderRadius: 12, cursor: "pointer", width: "100%",
      background: primary ? `linear-gradient(135deg, ${C.HEADER}, ${C.BLUE})` : "transparent",
      color: primary ? "white" : C.TEXT2,
      border: primary ? "none" : `1px solid ${C.DIM}40`,
      ...style,
    }} {...props}>{children}</button>
  );

  // ================================================================
  // SCREENS
  // ================================================================

  // ---- HOME ----
  if (screen === "home") return (
    <div style={{ minHeight: "100vh", display: "flex", flexDirection: "column", alignItems: "center", justifyContent: "center", padding: 24, background: `linear-gradient(165deg, ${C.BG} 0%, #0F1A30 50%, #141E35 100%)` }}>
      <div style={{ position: "absolute", inset: 0, backgroundImage: `linear-gradient(${C.HEADER}08 1px, transparent 1px), linear-gradient(90deg, ${C.HEADER}08 1px, transparent 1px)`, backgroundSize: "40px 40px", pointerEvents: "none" }} />

      <div className="fade-up" style={{ position: "relative", zIndex: 1, textAlign: "center", maxWidth: 400, width: "100%" }}>
        <div style={{ width: 60, height: 60, margin: "0 auto 16px", background: `linear-gradient(135deg, ${C.RED}, ${C.GOLD})`, borderRadius: 14, display: "flex", alignItems: "center", justifyContent: "center", fontSize: 26, fontWeight: 800, color: "white", boxShadow: `0 8px 32px ${C.RED}40` }}>
          GT
        </div>

        <h1 style={{ fontSize: 28, fontWeight: 800, color: C.TEXT, letterSpacing: "-0.02em" }}>Game Theory Lab</h1>
        <p style={{ fontSize: 13, color: C.GOLD, letterSpacing: "0.15em", textTransform: "uppercase", fontWeight: 600, margin: "4px 0 0" }}>
          ECON2501 Â· åšå¼ˆè®ºå®éªŒå®¤
        </p>
        <p style={{ fontSize: 12, color: C.DIM, margin: "8px 0 28px" }}></p>

        {!firebaseReady && (
          <div style={{ background: `${C.RED}15`, border: `1px solid ${C.RED}40`, borderRadius: 10, padding: 12, marginBottom: 16, fontSize: 12, color: "#FF8A80", textAlign: "left" }}>
            âš ï¸ Firebase æœªé…ç½®ã€‚äººäººå¯¹æˆ˜æ¨¡å¼ä¸å¯ç”¨ã€‚<br/>è¯·æŒ‰ index.html é¡¶éƒ¨è¯´æ˜é…ç½® Firebaseã€‚<br/>AI å¯¹æˆ˜æ¨¡å¼å¯æ­£å¸¸ä½¿ç”¨ã€‚
          </div>
        )}

        <input type="text" placeholder="ä½ çš„åå­— / Your name" value={name}
          onChange={e => setName(e.target.value)}
          style={{ width: "100%", padding: "13px 16px", fontSize: 15, background: C.SURFACE, border: `1px solid ${C.HEADER}40`, borderRadius: 11, color: C.TEXT, outline: "none", marginBottom: 10 }}
          onFocus={e => e.target.style.borderColor = C.GOLD}
          onBlur={e => e.target.style.borderColor = `${C.HEADER}40`}
        />
        <input type="text" placeholder="å­¦å· / Student ID" value={studentId}
          onChange={e => setStudentId(e.target.value)}
          style={{ width: "100%", padding: "13px 16px", fontSize: 15, background: C.SURFACE, border: `1px solid ${C.HEADER}40`, borderRadius: 11, color: C.TEXT, outline: "none", marginBottom: 16 }}
          onFocus={e => e.target.style.borderColor = C.GOLD}
          onBlur={e => e.target.style.borderColor = `${C.HEADER}40`}
        />

        <div style={{ marginBottom: 12 }}>
          <button className="btn-press" onClick={() => {
            if (!name.trim() || !studentId.trim()) { alert("è¯·å¡«å†™å§“åå’Œå­¦å·\nPlease fill in name and student ID"); return; }
            setMode("human"); setScreen("intro");
          }}
            style={{ width: "100%", padding: "18px 12px", fontSize: 15, fontWeight: 700, background: `linear-gradient(135deg, ${C.HEADER}, ${C.BLUE})`, border: "none", borderRadius: 12, color: "white", cursor: "pointer", opacity: firebaseReady ? 1 : 0.4, boxShadow: `0 4px 20px ${C.BLUE}50` }}
            disabled={!firebaseReady}>
            <div style={{ fontSize: 22, marginBottom: 2 }}>ğŸ®</div>
            å¼€å§‹æ¸¸æˆ Start Game
          </button>
        </div>

        <div style={{ display: "flex", gap: 10 }}>
          <button className="btn-press" onClick={() => {
            const pw = prompt("è¯·è¾“å…¥æ•™å¸ˆå¯†ç  / Enter teacher password:");
            if (pw === "econ2501") { loadStats(); setScreen("teacher"); }
            else if (pw !== null) alert("å¯†ç é”™è¯¯ / Wrong password");
          }}
            style={{ flex: 1, padding: 11, fontSize: 12, background: "transparent", border: `1px solid ${C.DIM}35`, borderRadius: 10, color: C.TEXT2, cursor: "pointer" }}>
            ğŸ“ æ•™å¸ˆé¢æ¿
          </button>
          <button className="btn-press" onClick={() => { loadStats(); setScreen("history"); }}
            style={{ flex: 1, padding: 11, fontSize: 12, background: "transparent", border: `1px solid ${C.DIM}35`, borderRadius: 10, color: C.TEXT2, cursor: "pointer" }}>
            ğŸ“Š å†å²è®°å½•
          </button>
        </div>
      </div>
    </div>
  );

  // ---- INTRO (Game Description) ----
  if (screen === "intro") {
    const intro = game.intro;
    return (
      <div style={{ minHeight: "100vh", display: "flex", flexDirection: "column", alignItems: "center", padding: 24, background: `linear-gradient(165deg, ${C.BG} 0%, #0F1A30 100%)`, overflowY: "auto" }}>
        <button className="btn-press" onClick={() => setScreen("home")}
          style={{ position: "fixed", top: 14, left: 14, background: "none", border: "none", color: C.TEXT2, fontSize: 13, cursor: "pointer", zIndex: 10 }}>â† Back è¿”å›</button>

        <div style={{ maxWidth: 420, width: "100%", paddingTop: 30 }}>
          {/* Header */}
          <div className="fade-up" style={{ textAlign: "center", marginBottom: 20 }}>
            <div style={{ fontSize: 48, marginBottom: 6 }}>{intro.emoji}</div>
            <div style={{ fontSize: 11, color: C.GOLD, letterSpacing: "0.12em", textTransform: "uppercase", marginBottom: 4 }}>Week {game.week}</div>
            <h2 style={{ fontSize: 24, fontWeight: 800, color: C.TEXT, marginBottom: 2 }}>{game.nameCN}</h2>
            <p style={{ fontSize: 14, color: C.TEXT2 }}>{game.name}</p>
          </div>

          {/* Story */}
          <div className="fade-up fade-up-1" style={{ background: C.SURFACE, borderRadius: 14, padding: 16, border: `1px solid ${C.HEADER}25`, marginBottom: 14 }}>
            <div style={{ fontSize: 12, fontWeight: 700, color: C.GOLD, marginBottom: 8 }}>ğŸ“– æ•…äº‹èƒŒæ™¯ Story</div>
            <p style={{ fontSize: 13, color: C.TEXT, lineHeight: 1.7, marginBottom: 8 }}>{intro.story}</p>
            <p style={{ fontSize: 11, color: C.DIM, lineHeight: 1.5, fontStyle: "italic" }}>{intro.storySub}</p>
          </div>

          {/* Rules */}
          <div className="fade-up fade-up-2" style={{ background: C.SURFACE, borderRadius: 14, padding: 16, border: `1px solid ${C.HEADER}25`, marginBottom: 14 }}>
            <div style={{ fontSize: 12, fontWeight: 700, color: C.GOLD, marginBottom: 10 }}>ğŸ“‹ æ¸¸æˆè§„åˆ™ Game Rules</div>
            {intro.rules.map((r, i) => (
              <div key={i} style={{ display: "flex", alignItems: "center", gap: 10, padding: "8px 0", borderBottom: i < intro.rules.length - 1 ? `1px solid ${C.DIM}15` : "none" }}>
                <div style={{ fontSize: 20, width: 32, textAlign: "center", flexShrink: 0 }}>{r.icon}</div>
                <div style={{ flex: 1 }}>
                  <div style={{ fontSize: 12, color: C.TEXT2 }}>{r.strats}</div>
                  <div style={{ fontSize: 13, fontWeight: 600, color: C.TEXT }}>{r.outcome}</div>
                  <div style={{ fontSize: 11, color: C.DIM }}>{r.en}</div>
                </div>
              </div>
            ))}
          </div>

          {/* AI info (if AI mode) */}
          {mode === "ai" && (
            <div className="fade-up fade-up-3" style={{ background: "linear-gradient(135deg, #1A1035, #2A1A40)", borderRadius: 14, padding: 16, border: `1px solid #4A307050`, marginBottom: 14, display: "flex", alignItems: "center", gap: 14 }}>
              <div style={{ width: 48, height: 48, borderRadius: 12, background: "linear-gradient(135deg, #D4A84B, #C00000)", display: "flex", alignItems: "center", justifyContent: "center", fontSize: 22, flexShrink: 0 }}>ğŸ¤–</div>
              <div>
                <div style={{ fontSize: 14, fontWeight: 700, color: C.PURPLE }}>Claude AI</div>
                <div style={{ fontSize: 12, color: C.TEXT2, lineHeight: 1.5 }}>ä½ çš„å¯¹æ‰‹æ˜¯AIã€‚å®ƒä¼šåˆ†æåšå¼ˆç»“æ„å’Œä½ çš„å†å²é€‰æ‹©ï¼Œåšå‡ºç­–ç•¥æ€§å†³å®šã€‚<br/><span style={{ color: C.DIM }}>Your opponent is an AI that analyzes the game and your history.</span></div>
              </div>
            </div>
          )}

          {/* Start button */}
          <button className="btn-press" onClick={() => setScreen("play")}
            style={{
              width: "100%", padding: "16px", fontSize: 16, fontWeight: 700,
              background: mode === "ai" ? "linear-gradient(135deg, #2D1B4E, #4A3070)" : `linear-gradient(135deg, ${C.HEADER}, ${C.BLUE})`,
              border: "none", borderRadius: 12, color: "white", cursor: "pointer",
              boxShadow: `0 4px 24px ${mode === "ai" ? "#2D1B4E" : C.BLUE}50`,
              marginBottom: 30,
            }}>
            {mode === "ai" ? `âš”ï¸ å¼€å§‹å¯¹æˆ˜ AI` : `ğŸ‘¥ å¼€å§‹åŒ¹é…å¯¹æ‰‹`}
          </button>
        </div>
      </div>
    );
  }

  // ---- PLAY ----
  if (screen === "play") return (
    <div style={{ minHeight: "100vh", display: "flex", flexDirection: "column", alignItems: "center", justifyContent: "center", padding: 24, background: `linear-gradient(165deg, ${C.BG} 0%, #0F1A30 100%)` }}>
      <button className="btn-press" onClick={() => { setScreen("home"); setWaiting(false); setChoice(null); }}
        style={{ position: "fixed", top: 14, left: 14, background: "none", border: "none", color: C.TEXT2, fontSize: 13, cursor: "pointer" }}>â† è¿”å›</button>

      <div style={{ maxWidth: 400, width: "100%", textAlign: "center" }}>
        <p style={{ fontSize: 11, color: C.GOLD, letterSpacing: "0.12em", textTransform: "uppercase", marginBottom: 4 }}>
          {game.nameCN} Â· Week {game.week}
        </p>

        {!waiting ? (
          <div className="fade-up">
            <h2 style={{ fontSize: 22, fontWeight: 800, color: C.TEXT, marginBottom: 6 }}>é€‰æ‹©ä½ çš„ç­–ç•¥ Make Your Choice</h2>
            <p style={{ fontSize: 12, color: C.TEXT2, marginBottom: 6 }}>
              {mode === "ai" ? "å¯¹æˆ˜ Claude AI" : "å¯¹æˆ˜çœŸäºº Random anonymous matching"}
            </p>
            <p style={{ fontSize: 12, color: C.DIM, marginBottom: 20 }}>{game.descCN}</p>

            {/* Payoff matrix toggle */}
            <div style={{ marginBottom: 20 }}>
              <button className="btn-press" onClick={() => setShowMatrix(!showMatrix)}
                style={{ fontSize: 11, color: C.DIM, background: "none", border: `1px solid ${C.DIM}25`, borderRadius: 6, padding: "5px 10px", cursor: "pointer" }}>
                {showMatrix ? "â–² éšè— Hide" : "â–¼ æ”¶ç›ŠçŸ©é˜µ Payoff Matrix"}
              </button>
              {showMatrix && (
                <div style={{ marginTop: 10, background: C.SURFACE, borderRadius: 10, padding: 12, border: `1px solid ${C.HEADER}25` }}>
                  <table style={{ width: "100%", borderCollapse: "collapse", fontSize: 12 }}>
                    {game.matrix.map((row, i) => (
                      <tr key={i}>
                        {row.map((cell, j) => (
                          <td key={j} style={{
                            padding: "8px 6px", textAlign: "center",
                            fontWeight: i === 0 || j === 0 ? 700 : 400,
                            color: i === 0 || j === 0 ? C.GOLD : C.TEXT,
                            background: (i === 1 && j === 1) ? `${C.RED}12` : (i === 2 && j === 2) ? `${C.GOLD}12` : "transparent",
                            borderRadius: 4,
                          }}>{cell}</td>
                        ))}
                      </tr>
                    ))}
                  </table>
                  <p style={{ fontSize: 10, color: C.DIM, marginTop: 6 }}>Format: your grade, their grade</p>
                </div>
              )}
            </div>

            {/* Strategy buttons */}
            <div style={{ display: "flex", gap: 16, justifyContent: "center" }}>
              {game.strategies.map(strat => (
                <button key={strat} className="btn-press" onClick={() => handleChoice(strat)}
                  style={{
                    width: 130, height: 150, fontSize: 44, fontWeight: 800,
                    background: strat === "Î±" ? `linear-gradient(145deg, ${C.ALPHA_BG}, #0F2040)` : `linear-gradient(145deg, ${C.BETA_BG}, #1A1035)`,
                    border: `2px solid ${strat === "Î±" ? C.HEADER : "#4A3070"}`,
                    borderRadius: 18, color: strat === "Î±" ? C.ALPHA_C : C.BETA_C,
                    cursor: "pointer", display: "flex", flexDirection: "column",
                    alignItems: "center", justifyContent: "center",
                    boxShadow: `0 6px 24px ${strat === "Î±" ? C.BLUE : "#2D1B4E"}35`,
                  }}>
                  {strat}
                  <div style={{ fontSize: 11, fontWeight: 400, marginTop: 6, opacity: 0.5, color: C.TEXT2 }}>
                    {strat === "Î±" ? "Alpha" : "Beta"}
                  </div>
                </button>
              ))}
            </div>
          </div>
        ) : (
          <div className="fade-up" style={{ padding: 40 }}>
            {/* Countdown circle */}
            <div style={{ position: "relative", width: 80, height: 80, margin: "0 auto 16px" }}>
              <svg width="80" height="80" style={{ transform: "rotate(-90deg)" }}>
                <circle cx="40" cy="40" r="34" fill="none" stroke={`${C.DIM}25`} strokeWidth="4" />
                <circle cx="40" cy="40" r="34" fill="none" stroke={C.GOLD} strokeWidth="4"
                  strokeDasharray={`${2 * Math.PI * 34}`}
                  strokeDashoffset={`${2 * Math.PI * 34 * (1 - countdown / 30)}`}
                  strokeLinecap="round"
                  style={{ transition: "stroke-dashoffset 1s linear" }} />
              </svg>
              <div style={{ position: "absolute", inset: 0, display: "flex", alignItems: "center", justifyContent: "center", fontSize: 24, fontWeight: 800, color: C.GOLD }}>
                {countdown}
              </div>
            </div>

            <h2 style={{ fontSize: 18, color: C.TEXT, marginBottom: 6 }}>
              ç­‰å¾…åŒå­¦ä»¬æäº¤... Waiting for classmates...
            </h2>
            <p style={{ fontSize: 12, color: C.DIM }}>
              {countdown > 0 ? `${countdown} ç§’åéšæœºé…å¯¹ / Matching in ${countdown}s` : "Matching now... æ­£åœ¨é…å¯¹ä¸­..."}
            </p>
            <p style={{ fontSize: 14, color: C.TEXT2, marginTop: 12 }}>
              ä½ é€‰æ‹©äº† <strong style={{ color: choice === "Î±" ? C.ALPHA_C : C.BETA_C, fontSize: 18 }}>{choice}</strong>
            </p>
            <p style={{ fontSize: 11, color: C.DIM, marginTop: 8 }}>
              âœ“ å·²æäº¤ Submitted â€” è¯·ç­‰å¾… Please wait
            </p>
          </div>
        )}
      </div>
    </div>
  );

  // ---- RESULT ----
  if (screen === "result" && result) {
    const win = result.myPay > result.oppPay;
    const tie = result.myPay === result.oppPay;

    return (
      <div style={{ minHeight: "100vh", display: "flex", flexDirection: "column", alignItems: "center", justifyContent: "center", padding: 24, background: win ? `linear-gradient(165deg, #0B200F, #0F1A30)` : tie ? `linear-gradient(165deg, #1A1A0B, #0F1A30)` : `linear-gradient(165deg, #200B0B, #0F1A30)` }}>
        <div style={{ maxWidth: 400, width: "100%", textAlign: "center" }}>

          <div className="fade-up" style={{ fontSize: 44, marginBottom: 4 }}>
            {win ? "ğŸ‰" : tie ? "ğŸ¤" : "ğŸ˜¤"}
          </div>
          <h2 className="fade-up fade-up-1" style={{ fontSize: 24, fontWeight: 800, color: C.TEXT, marginBottom: 2 }}>
            {result.label}
          </h2>
          <p className="fade-up fade-up-1" style={{ fontSize: 12, color: C.TEXT2, marginBottom: 20 }}>
            vs {result.oppName}
          </p>

          {/* Cards */}
          <div className="fade-up fade-up-2" style={{ display: "flex", gap: 12, marginBottom: 20 }}>
            <Box style={{ flex: 1, textAlign: "center" }}>
              <div style={{ fontSize: 10, color: C.DIM, marginBottom: 2 }}>ä½ çš„é€‰æ‹©</div>
              <div style={{ fontSize: 32, fontWeight: 800, color: result.myChoice === "Î±" ? C.ALPHA_C : C.BETA_C }}>{result.myChoice}</div>
              <div style={{ fontSize: 18, fontWeight: 700, color: result.myPay >= 0 ? C.GREEN : C.RED, marginTop: 2 }}>
                {result.myPay > 0 ? "+" : ""}{result.myPay}
              </div>
            </Box>
            <Box style={{ flex: 1, textAlign: "center" }}>
              <div style={{ fontSize: 10, color: C.DIM, marginBottom: 2 }}>å¯¹æ–¹é€‰æ‹©</div>
              <div style={{ fontSize: 32, fontWeight: 800, color: result.oppChoice === "Î±" ? C.ALPHA_C : C.BETA_C }}>{result.oppChoice}</div>
              <div style={{ fontSize: 18, fontWeight: 700, color: result.oppPay >= 0 ? C.GREEN : C.RED, marginTop: 2 }}>
                {result.oppPay > 0 ? "+" : ""}{result.oppPay}
              </div>
            </Box>
          </div>

          {/* Lesson */}
          <div className="fade-up fade-up-3" style={{ background: `${C.GOLD}0C`, border: `1px solid ${C.GOLD}25`, borderRadius: 12, padding: 14, marginBottom: 14, textAlign: "left" }}>
            <div style={{ fontSize: 12, fontWeight: 700, color: C.GOLD, marginBottom: 4 }}>
              ğŸ’¡ {game.lessonTitle}
            </div>
            <div style={{ fontSize: 12, color: C.TEXT2, lineHeight: 1.65 }}>
              {game.lessons[result.key].split("\n\n").map((para, i) => (
                <p key={i} style={{ margin: i === 0 ? "0 0 8px" : "0", color: i === 0 ? C.TEXT2 : C.DIM, fontStyle: i === 0 ? "normal" : "italic" }}>{para}</p>
              ))}
            </div>
          </div>

          {/* Claude AI Reasoning */}
          {result.aiReasoningCN && (
            <div className="fade-up fade-up-3" style={{ background: "linear-gradient(135deg, #1A1035, #1F1540)", border: "1px solid #4A307040", borderRadius: 12, padding: 14, marginBottom: 14, textAlign: "left" }}>
              <div style={{ fontSize: 12, fontWeight: 700, color: C.PURPLE, marginBottom: 8, display: "flex", alignItems: "center", gap: 6 }}>
                <span style={{ display: "inline-flex", width: 20, height: 20, borderRadius: 5, background: "linear-gradient(135deg, #D4A84B, #C00000)", alignItems: "center", justifyContent: "center", fontSize: 10 }}>ğŸ¤–</span>
                Claude AI çš„æ€è€ƒè¿‡ç¨‹ Claude's Reasoning
              </div>
              <div style={{ fontSize: 12, color: C.TEXT, lineHeight: 1.7, marginBottom: 8 }}>
                {result.aiReasoningCN}
              </div>
              <div style={{ fontSize: 11, color: C.DIM, lineHeight: 1.6, fontStyle: "italic", borderTop: `1px solid ${C.DIM}15`, paddingTop: 8 }}>
                {result.aiReasoningEN}
              </div>
            </div>
          )}

          {/* AI history */}
          {mode === "ai" && aiHistory.length > 1 && (
            <div style={{ marginBottom: 16 }}>
              <div style={{ fontSize: 11, color: C.DIM, marginBottom: 6 }}>å¯¹æˆ˜è®°å½• History ({aiHistory.length} å±€ rounds)</div>
              <div style={{ display: "flex", gap: 3, justifyContent: "center", flexWrap: "wrap" }}>
                {aiHistory.map((h, i) => (
                  <div key={i} style={{
                    width: 28, height: 28, borderRadius: 6, fontSize: 10, fontWeight: 700,
                    display: "flex", alignItems: "center", justifyContent: "center",
                    background: h.mine === "Î±" && h.opp === "Î±" ? `${C.RED}20` : h.mine === "Î²" && h.opp === "Î²" ? `${C.GREEN}20` : `${C.GOLD}15`,
                    color: h.mine === "Î±" && h.opp === "Î±" ? C.RED : h.mine === "Î²" && h.opp === "Î²" ? C.GREEN : C.GOLD,
                  }}>{h.mine}{h.opp}</div>
                ))}
              </div>
            </div>
          )}

          <div style={{ display: "flex", gap: 10 }}>
            <Btn primary onClick={playAgain}>å†æ¥ä¸€å±€ Play Again</Btn>
            <Btn onClick={() => { setChoice(null); setResult(null); setScreen("home"); }}>è¿”å›é¦–é¡µ Home</Btn>
          </div>
        </div>
      </div>
    );
  }

  // ---- TEACHER ----
  if (screen === "teacher") {
    const total = stats.alpha + stats.beta;
    const aR = total > 0 ? Math.round(stats.alpha / total * 100) : 0;
    const bR = total > 0 ? Math.round(stats.beta / total * 100) : 0;

    return (
      <div style={{ minHeight: "100vh", padding: 24, background: `linear-gradient(165deg, ${C.BG}, #0F1A30)` }}>
        <div style={{ maxWidth: 460, margin: "0 auto" }}>
          <button className="btn-press" onClick={() => setScreen("home")} style={{ background: "none", border: "none", color: C.TEXT2, fontSize: 13, cursor: "pointer", marginBottom: 14 }}>â† è¿”å›</button>

          <h2 style={{ fontSize: 22, fontWeight: 800, color: C.TEXT, marginBottom: 2 }}>ğŸ“ æ•™å¸ˆé¢æ¿ Teacher Panel</h2>
          <p style={{ fontSize: 12, color: C.TEXT2, marginBottom: 20 }}>{game.nameCN} Â· å®æ—¶è¯¾å ‚ç»Ÿè®¡ Live Stats</p>

          <div style={{ display: "flex", gap: 12, marginBottom: 16 }}>
            <Box style={{ flex: 1, textAlign: "center" }}>
              <div style={{ fontSize: 32, fontWeight: 800, color: C.ALPHA_C }}>{aR}%</div>
              <div style={{ fontSize: 12, color: C.TEXT2 }}>Chose Î± é€‰æ‹© Î±</div>
              <div style={{ fontSize: 10, color: C.DIM }}>{stats.alpha}/{total} äºº</div>
            </Box>
            <Box style={{ flex: 1, textAlign: "center" }}>
              <div style={{ fontSize: 32, fontWeight: 800, color: C.BETA_C }}>{bR}%</div>
              <div style={{ fontSize: 12, color: C.TEXT2 }}>Chose Î² é€‰æ‹© Î²</div>
              <div style={{ fontSize: 10, color: C.DIM }}>{stats.beta}/{total} äºº</div>
            </Box>
          </div>

          {/* Bar */}
          <Box style={{ marginBottom: 16 }}>
            <div style={{ fontSize: 11, color: C.DIM, marginBottom: 6 }}>ç­–ç•¥åˆ†å¸ƒ Distribution</div>
            <div style={{ display: "flex", height: 28, borderRadius: 8, overflow: "hidden", background: `${C.DIM}20` }}>
              <div style={{ width: `${aR}%`, background: `linear-gradient(90deg, #3A7BD5, ${C.ALPHA_C})`, transition: "width 0.6s ease", display: "flex", alignItems: "center", justifyContent: "center", fontSize: 11, fontWeight: 700, color: "white" }}>
                {aR > 12 ? `Î± ${aR}%` : ""}
              </div>
              <div style={{ width: `${bR}%`, background: `linear-gradient(90deg, #7B4FBF, ${C.BETA_C})`, transition: "width 0.6s ease", display: "flex", alignItems: "center", justifyContent: "center", fontSize: 11, fontWeight: 700, color: "white" }}>
                {bR > 12 ? `Î² ${bR}%` : ""}
              </div>
            </div>
          </Box>

          {/* Polak comparison */}
          <Box style={{ background: `${C.GOLD}08`, border: `1px solid ${C.GOLD}20`, marginBottom: 16 }}>
            <div style={{ fontSize: 12, fontWeight: 700, color: C.GOLD, marginBottom: 6 }}>ğŸ“– å¯¹æ¯” Polak (Yale 2007) Comparison</div>
            <div style={{ fontSize: 11, color: C.TEXT2, lineHeight: 1.6 }}>
              è€¶é²è¯¾å ‚ Yale: ~85% chose Î±, ~15% chose Î²<br/>
              æ™®é€šäººå®éªŒ General public: ~70% chose Î±, ~30% chose Î²<br/><br/>
              <strong style={{ color: C.TEXT }}>ä½ çš„è¯¾å ‚ Your class: {aR}% Î±, {bR}% Î² ({total} students)</strong><br/>
              {total === 0 ? "è¿˜æ²¡æœ‰æ•°æ® No data yet â€” start the game!" :
               aR > 75 ? "å’Œè€¶é²å­¦ç”Ÿå·®ä¸å¤šï¼Similar to Yale â€” most chose the dominant strategy (under selfish preferences)" :
               bR > 50 ? "ä½ çš„å­¦ç”Ÿæ›´å€¾å‘åˆä½œ Your students prefer cooperation â€” interesting! Why?" :
               "æœ‰è¶£çš„åˆ†å¸ƒï¼Interesting â€” great for class discussion."}
            </div>
          </Box>

          {/* Recent results */}
          {stats.results.length > 0 && (
            <Box>
              <div style={{ fontSize: 11, color: C.DIM, marginBottom: 8 }}>æœ€è¿‘ç»“æœ Recent Resultsï¼ˆå«å­¦å·å’ŒéªŒè¯ç ï¼‰</div>
              {stats.results.slice(0, 20).map((r, i) => (
                <div key={i} style={{ display: "flex", justifyContent: "space-between", alignItems: "center", padding: "7px 0", borderBottom: i < 19 ? `1px solid ${C.DIM}15` : "none", fontSize: 12 }}>
                  <div style={{ flex: 1 }}>
                    <span style={{ color: C.TEXT, fontWeight: 600 }}>{r.player}</span>
                    {r.studentId && <span style={{ color: C.DIM, fontSize: 10, marginLeft: 6 }}>{r.studentId}</span>}
                    {r.section && <span style={{ color: C.ALPHA_C, fontSize: 9, marginLeft: 4, background: `${C.ALPHA_C}15`, padding: "1px 5px", borderRadius: 3 }}>{r.section}</span>}
                    {r.sessionCode && <span style={{ color: C.GOLD, fontSize: 9, marginLeft: 4, background: `${C.GOLD}15`, padding: "1px 5px", borderRadius: 3 }}>{r.sessionCode}</span>}
                  </div>
                  <span style={{ color: C.TEXT2, marginRight: 8 }}>
                    <span style={{ color: r.choice === "Î±" ? C.ALPHA_C : C.BETA_C, fontWeight: 700 }}>{r.choice}</span>
                    {" vs "}
                    <span style={{ color: r.oppChoice === "Î±" ? C.ALPHA_C : C.BETA_C, fontWeight: 700 }}>{r.oppChoice}</span>
                  </span>
                  <span style={{ color: r.payoff >= 0 ? C.GREEN : C.RED, fontWeight: 700, minWidth: 28, textAlign: "right" }}>
                    {r.payoff > 0 ? "+" : ""}{r.payoff}
                  </span>
                </div>
              ))}
            </Box>
          )}

          <div style={{ display: "flex", gap: 10, marginTop: 12 }}>
            <button className="btn-press" onClick={loadStats}
              style={{ flex: 1, padding: 11, fontSize: 12, background: "transparent", border: `1px solid ${C.DIM}30`, borderRadius: 10, color: C.TEXT2, cursor: "pointer" }}>
              ğŸ”„ åˆ·æ–° Refresh
            </button>
            <button className="btn-press" onClick={async () => {
              if (!firebaseReady) return;
              const pw = prompt("ç¡®è®¤æ¸…é™¤æ‰€æœ‰æ•°æ®ï¼Ÿè¾“å…¥ reset ç¡®è®¤\nClear all data? Type 'reset' to confirm:");
              if (pw !== "reset") return;
              await db.ref(`games/${gameId}`).remove();
              setStats({ alpha: 0, beta: 0, results: [] });
              alert("âœ… æ•°æ®å·²æ¸…é™¤ / All data cleared");
            }}
              style={{ flex: 1, padding: 11, fontSize: 12, background: "transparent", border: `1px solid ${C.RED}40`, borderRadius: 10, color: C.RED, cursor: "pointer" }}>
              ğŸ—‘ï¸ æ¸…é™¤ Reset All
            </button>
          </div>
        </div>
      </div>
    );
  }

  // ---- HISTORY ----
  if (screen === "history") return (
    <div style={{ minHeight: "100vh", padding: 24, background: `linear-gradient(165deg, ${C.BG}, #0F1A30)` }}>
      <div style={{ maxWidth: 460, margin: "0 auto" }}>
        <button className="btn-press" onClick={() => setScreen("home")} style={{ background: "none", border: "none", color: C.TEXT2, fontSize: 13, cursor: "pointer", marginBottom: 14 }}>â† è¿”å›</button>
        <h2 style={{ fontSize: 22, fontWeight: 800, color: C.TEXT, marginBottom: 16 }}>ğŸ“Š å†å²è®°å½• History</h2>
        {stats.results.length === 0 ? (
          <p style={{ color: C.DIM, fontSize: 13 }}>è¿˜æ²¡æœ‰è®°å½•ã€‚å»ç©ä¸€å±€å§ï¼No records yet â€” go play!</p>
        ) : stats.results.map((r, i) => (
          <Box key={i} style={{ marginBottom: 8, display: "flex", justifyContent: "space-between", alignItems: "center" }}>
            <div>
              <div style={{ fontSize: 13, fontWeight: 600, color: C.TEXT }}>{r.player}</div>
              <div style={{ fontSize: 10, color: C.DIM }}>
                {r.choice} vs {r.opponent}({r.oppChoice})
              </div>
            </div>
            <div style={{ fontSize: 15, fontWeight: 700, color: r.payoff >= 0 ? C.GREEN : C.RED }}>
              {r.payoff > 0 ? "+" : ""}{r.payoff}
            </div>
          </Box>
        ))}
      </div>
    </div>
  );

  return null;
}

ReactDOM.render(<App />, document.getElementById("app"));
</script>
</body>
</html>
